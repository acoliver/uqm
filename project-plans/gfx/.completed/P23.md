# Phase 23: C File Guards — Level 1-2 — Completed (Deferred)

- **Phase ID**: PLAN-20260223-GFX-FULL-PORT.P23
- **Completed**: 2026-02-23
- **Status**: [DEFERRED] No additional guards can be applied yet

## Scope Assessment

The original plan called for guarding ~14 Level 1-2 files including:
- Drawing layer: `dcqueue.c`, `tfb_draw.c`, `tfb_prim.c`, `canvas.c`
- Colormap/palette: `cmap.c`, `palette.c`
- Core abstractions: `pixmap.c`, `gfx_common.c`
- SDL backend: `sdl2_pure.c`, `sdl2_common.c`, `sdl1_common.c`, `pure.c`, `sdluio.c`

## Why No Guards Were Applied

**All Level 1-2 files are still actively used by the C game code.** The Rust
implementations exist but the C-to-Rust FFI bridge does not yet replace the
C function symbols at link time. Specifically:

1. **Drawing layer** (`dcqueue.c`, `tfb_draw.c`, `tfb_prim.c`, `canvas.c`):
   The C game code calls these functions directly. The Rust equivalents
   (`dcqueue.rs`, `tfb_draw.rs`, `canvas_ffi.rs`) are callable via the
   `rust_*` FFI functions in `rust_gfx.h`, but the C callers still use
   the original C function names (e.g., `TFB_DrawScreen_Line`, not
   `rust_canvas_draw_line`).

2. **Colormap** (`cmap.c`, `palette.c`): C game code calls `SetColorMap`,
   `FadeScreen`, etc. directly.

3. **Core abstractions** (`gfx_common.c`, `pixmap.c`): `TFB_InitGraphics`,
   `TFB_UninitGraphics`, etc. are called from C startup code.

4. **SDL backend** (`sdl2_pure.c`, `sdl2_common.c`, `pure.c`, etc.): These
   implement the `TFB_GRAPHICS_BACKEND` vtable that `gfx_common.c` uses.

5. **Cascade dependencies**: Even the scaler files that P22 intended to guard
   (`2xscalers.c`, `rotozoom.c`, template scalers) cannot be guarded because
   `canvas.c` and `scalers.c` depend on them.

## Prerequisites for Future Guarding

Before Level 1-2 files can be guarded, the following must be completed:

1. **Symbol-level replacement**: Rust FFI must export the exact C function
   names (e.g., `TFB_DrawScreen_Line` not `rust_canvas_draw_line`), OR
   the C callers must be updated to call through conditional dispatch.

2. **Link-time substitution**: The build system must link the Rust library
   such that it provides the symbols that guarded C files would have provided.

3. **Integration testing**: Full game startup/rendering must work with the
   Rust path before guarding C files.

## What Was Accomplished

- Thorough dependency analysis of all C graphics files
- Confirmation that the 3 MMX/SSE/3DNow scaler files (guarded in P22) are
  the only files that can currently be safely guarded
- Documentation of the dependency chains blocking further guards
- Build verification confirming no regressions

## Files with USE_RUST_GFX (unchanged from P22)

| File | Type |
|------|------|
| `sdl/2xscalers_mmx.c` | Full guard (new in P22) |
| `sdl/2xscalers_sse.c` | Full guard (new in P22) |
| `sdl/2xscalers_3dnow.c` | Full guard (new in P22) |
| `sdl/scalers.c` | Partial guard (pre-existing) |
| `sdl/sdl_common.c` | Partial guard (pre-existing) |
| `sdl/rust_gfx.h` | FFI declarations (pre-existing) |

## Verification Results

```
C build: PASS (cd sc2 && ./build.sh uqm — no errors)
No undefined symbols: PASS
All pre-existing guards intact: PASS
```
