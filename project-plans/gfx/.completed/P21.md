# Phase 21: Colormap FFI Bridge — Completed

- **Phase ID**: PLAN-20260223-GFX-FULL-PORT.P21
- **Completed**: 2026-02-23
- **Status**: [OK] All criteria met

## Files Created

- `rust/src/graphics/cmap_ffi.rs` — Colormap FFI bridge (10 exports, ~925 lines)

## Files Modified

- `rust/src/graphics/mod.rs` — Added `pub mod cmap_ffi;`
- `sc2/src/libs/graphics/sdl/rust_gfx.h` — Added `rust_cmap_*` declarations (10 functions)

## Colormap FFI Exports (10)

| # | Function | Purpose |
|---|---|---|
| 1 | `rust_cmap_init` | Initialize colormap manager singleton |
| 2 | `rust_cmap_uninit` | Tear down colormap manager |
| 3 | `rust_cmap_set` | Set colormap data (RGB byte triples) |
| 4 | `rust_cmap_get` | Get colormap data pointer (static buffer) |
| 5 | `rust_cmap_from_index` | Check if colormap index exists (1/0) |
| 6 | `rust_cmap_fade_screen` | Initiate fade (direction 0=black, 1=normal, 2=white) |
| 7 | `rust_cmap_get_fade_amount` | Query current fade level (0–510) |
| 8 | `rust_cmap_xform_step` | Step active color transformations |
| 9 | `rust_cmap_flush_xforms` | Finish all pending fades/transforms |
| 10 | `rust_cmap_set_palette` | Set palette colors on colormap 0 |

## Verification Results

```
#[no_mangle] count: 10 (≥8 [OK])
catch_unwind count: 22 (≥8 [OK]) — 10 in FFI exports + 12 in tests
Linkable symbols: 10 (≥8 [OK])
Deferred impl check: CLEAN [OK]
Unit tests: 35 cmap_ffi tests, all passing [OK]
Total tests: 1162 passed, 0 failed, 4 ignored [OK]
```

## Design Decisions

- **Static buffer for `rust_cmap_get`**: Returns `*const u8` via thread-local
  `UnsafeCell<Vec<u8>>` buffer, avoiding heap allocation per call. Buffer is
  overwritten on each call (matches C `GetColorMapAddress` semantics).
- **`fade_type_from_direction` helper**: Maps C integer directions (0=black,
  1=normal, 2=white) to Rust `FadeType` enum.
- **`rust_cmap_set_palette`**: Writes directly to colormap 0's palette via
  `set_colors()`, matching C `TFB_SetColorMap` behavior.
- **All exports use `catch_unwind(AssertUnwindSafe(...))`**: Consistent with
  `canvas_ffi.rs` and `dcq_ffi.rs` patterns.
