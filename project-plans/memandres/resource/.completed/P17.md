# Phase 17: Resource Dispatch — Implementation (COMPLETE)

## Phase ID
`PLAN-20260224-RES-SWAP.P17`

## Completion Date
2026-02-24

## What was done
Implemented all resource dispatch functions in `rust/src/resource/dispatch.rs`:

### Implemented methods (matching pseudocode from component-003.md)
- `process_resource_desc` — parses TYPE:path, calls loadFun immediately for value types (free_fun==None), defers for heap types
- `get_resource` — lazy load via loadFun on first access, increment refcount, return cached ptr on subsequent calls (lines 28-50)
- `free_resource` — guards: undefined/non-heap/not-loaded/unreferenced; decrement refcount, call freeFun at zero (lines 57-83)
- `detach_resource` — guards: undefined/non-heap/not-loaded/multi-ref; transfer ownership, clear ptr+refcount (lines 84-108)
- `remove_resource` — warn if live, call freeFun if loaded, remove from map (lines 109-124)
- `get_int_resource` — direct data.num access
- `get_boolean_resource` — data.num != 0
- `get_string_resource` — fname access
- `get_resource_type` — res_type access

### Safety
- All C function pointer calls wrapped in `unsafe` blocks
- Function pointers checked via `Option` before calling
- `fname_cstring` kept alive in `FullResourceDesc` for pointer stability
- `cur_resfile_name` set/cleared around loadFun calls per C convention

### Deferred
- `LoadResourceFromPath` (REQ-RES-031-033) — deferred to P20 (requires UIO integration)

## Structural Verification
- [x] All dispatch functions implemented
- [x] No `todo!()` markers remain
- [x] All unsafe blocks properly scoped and documented
- [x] Plan/requirement markers present

## Semantic Verification
- [x] All 13 P16 dispatch tests pass (GREEN)
- [x] Value types loaded immediately via loadFun
- [x] Lazy loading path implemented for heap types
- [x] Refcount lifecycle correct (increment on get, decrement on free, zero triggers freeFun)
- [x] Detach transfers ownership, fails if refcount > 1
- [x] Remove calls freeFun before dropping
- [x] All error/warning paths handled with log::warn!

## Test Results
- 13 new dispatch tests: ALL PASS
- 1281 total tests: ALL PASS (0 failures, 4 ignored)
- cargo fmt: clean
- clippy: no new warnings in dispatch.rs
