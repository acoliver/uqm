# Phase Completion: P22

## Phase ID
`PLAN-20260224-RES-SWAP.P22`

## Timestamp
2026-02-24

## Status: PASS

## Summary
P22 Integration Verification — three critical bugs fixed:

### Bug 1: ResourceData union initialization (ffi_types.rs)
`ResourceData::default()` used `num: 0` (4 bytes), leaving upper 4 bytes of the
8-byte `ptr` field uninitialized on 64-bit. Reading as `ptr` gave `0x100000000`.
**Fix**: Default to `ptr: null_mut()` which zeros all 8 bytes.

### Bug 2: C subsystem type registration (ffi_bridge.rs)  
`InitResourceSystem` only registered 5 built-in value types (STRING, INT32,
BOOLEAN, COLOR, UNKNOWNRES). The 9 heap types (GFXRES, FONTRES, STRTAB, BINTAB,
CONVERSATION, SNDRES, MUSICRES, 3DOVID, SHIP) were never registered because the
C registration functions were called from inside the guarded-out C `InitResourceSystem`.
**Fix**: Rust `InitResourceSystem` now calls the 5 C subsystem init functions
(InstallGraphicResTypes, InstallStringTableResType, InstallAudioResTypes,
InstallVideoResType, InstallCodeResType) with proper lock release to avoid deadlock.
Uses `c_types_registered` flag to handle early auto-init via `ensure_init`.

### Bug 3: GetResourceData incorrect implementation (ffi_bridge.rs)
Rust version was reading the entire file length including the 4-byte prefix
and treating non-0xFFFFFFFF prefixes as "compressed data" to keep.
**Fix**: Match C behavior exactly — if prefix != 0xFFFFFFFF, log warning and
return NULL. If uncompressed, allocate `length - 4` bytes and read data after
prefix. Use `libc::malloc` matching C's `AllocResourceData`.

## Tests
- 1321 passed, 0 failed, 4 ignored

## Verification
Game launches, loads all 5 .rmp indices, loads BINTAB/GFXRES/FONTRES/SNDRES/
MUSICRES resources successfully, reaches main menu with music playing.
