# Phase P13: Error Handling Hardening — Completed

## Phase ID
`PLAN-20260223-GFX-FULL-PORT.P13`

## Timestamp
2026-02-23

## Files Modified
- `rust/src/graphics/ffi.rs`

## Summary of Changes

### 1. Panic Boundary Audit (REQ-FFI-030)
All 17 `#[no_mangle] pub extern "C" fn` functions have been audited and
annotated with `// PANIC-FREE: <reason>` comments. No function required
`catch_unwind` — all use `if let`/`match` guards, range checks before
indexing, and result-discarding patterns for SDL operations.

### 2. Production `.unwrap()` / `.expect()` Elimination
Removed 4 `.unwrap()` calls from production FFI code:
- `NonZeroU32::new(1).unwrap()` in `rust_gfx_postprocess` → `match` with early return
- `Pixmap::new(...).unwrap()` in `rust_gfx_postprocess` → `match` with early return
- `sw_scale.unwrap()` in `rust_gfx_screen` → `match` with early return
- `NonZeroU32::new(1).unwrap()` in `rust_gfx_screen` → `match` with early return

### 3. `rust_gfx_upload_transition_screen` Documentation (REQ-UTS-010)
Replaced the "No-op for now" stub comment with a proper doc comment explaining
the architectural invariant: unconditional full-surface upload in ScreenLayer
(`rust_gfx_screen`) makes a separate transition texture upload unnecessary.
Eliminated the only `for now` deferred pattern in the file.

### 4. SAFETY Comment Enhancement (REQ-THR-030, REQ-THR-035)
Updated the `unsafe impl Sync for GraphicsStateCell` SAFETY comment to be
more explicit about the single-threaded access invariant, referencing
REQ-THR-010, REQ-THR-030, and REQ-THR-035.

### 5. Constraint Verification (Code Review)
- **REQ-INIT-095**: Already-initialized guard verified present at line 158
  (added in P03, test `test_init_already_initialized_returns_neg1` exists)
- **REQ-THR-030**: `GraphicsStateCell` uses `UnsafeCell` — verified
- **REQ-THR-035**: `unsafe impl Sync` has SAFETY comment — verified and enhanced
- **REQ-FFI-040**: All 17 `pub extern "C" fn` have `#[no_mangle]` — verified
- **REQ-FFI-060**: No re-entrant mutable access — `rust_gfx_get_sdl_screen` and
  `rust_gfx_get_transition_screen` delegate to `rust_gfx_get_screen_surface`,
  which is read-only (no mutable state access beyond the initial `get_gfx_state()`).
  No mutable re-entrancy risk.
- **REQ-THR-010**: No `thread::spawn`, `tokio`, `async`, `rayon`, or `crossbeam` in ffi.rs
- **REQ-THR-020**: No `Mutex`, `RwLock`, `Atomic*`, or `Condvar` in ffi.rs
- **REQ-ERR-030**: No `rust_bridge_log_msg` calls in `rust_gfx_screen` or
  `rust_gfx_color` validation paths (only in scaler-active one-time log paths)
- **REQ-ERR-040**: Every failure path in `rust_gfx_init` calls `rust_bridge_log_msg`
- **REQ-ERR-060**: All SDL operations in vtable functions use `if let Ok(...)`,
  `.is_err()`, or `let _ =` patterns — no per-frame logging on SDL failures

## Tests Added (8 new tests)
- `test_uninit_without_init_no_panic` — @requirement REQ-ERR-050
- `test_upload_transition_screen_no_panic` — @requirement REQ-UTS-010
- `test_out_of_sequence_no_crash` — @requirement REQ-SEQ-070
- `test_repeated_postprocess_no_crash` — @requirement REQ-INV-040
- `test_repeated_preprocess_no_crash` — @requirement REQ-INV-050
- `test_surface_accessors_uninitialized` — @requirement REQ-SURF-030
- `test_aux_functions_uninitialized` — @requirement REQ-AUX-060
- `test_all_ffi_functions_uninitialized_defaults` — @requirement REQ-ERR-010

## Tests (Pre-Existing, Verified Still Passing)
- `test_preprocess_uninitialized_no_panic` — REQ-PRE-050
- `test_postprocess_uninitialized_no_panic` — REQ-POST-030
- `test_init_already_initialized_returns_neg1` — REQ-INIT-095 (ignored, requires SDL2)
- `test_gfx_screen_uninitialized_no_panic` — REQ-SCR-140
- `test_gfx_color_uninitialized_no_panic` — REQ-CLR-060
- 20+ other pre-existing tests — all passing

## Verification Results

### cargo fmt
```
[OK] rust/src/graphics/ffi.rs — formatted (no diff)
```

### cargo clippy (graphics/ffi.rs only)
```
5 pre-existing warnings from prior phases (P03/P08/P11/P12):
- needless_range_loop in init surface cleanup (lines 289, 310)
- collapsible if in postprocess (line 578)
- not_unsafe_ptr_arg_deref in color (line 837) — extern "C" fn, expected
- match-to-if-let in process_events (line 871)
No new warnings from P13 changes.
```

### cargo test
```
running 32 tests
28 passed; 0 failed; 4 ignored (require SDL2 display)
```

### Deferred pattern check
```
grep "TODO\|FIXME\|HACK\|todo!\|unimplemented!\|for now\|will be implemented\|placeholder" → CLEAN
```

### No .unwrap()/.expect() in production code
```
All 6 remaining .unwrap() matches are in #[cfg(test)] code or in comments.
```

### PANIC-FREE audit
```
17 PANIC-FREE comments for 17 extern "C" fn declarations — complete.
```

## Semantic Checklist
- [x] All FFI functions tested with uninitialized state (REQ-ERR-010)
- [x] Uninit-without-init is safe (REQ-ERR-050)
- [x] Out-of-sequence calls don't crash (REQ-SEQ-070)
- [x] Repeated preprocess/postprocess calls don't corrupt (REQ-INV-040/050)
- [x] Surface accessors return null when uninitialized (REQ-SURF-030)
- [x] Auxiliary functions return correct defaults when uninitialized (REQ-AUX-060)
- [x] No per-frame logging in vtable functions (REQ-ERR-030) — verified by inspection
- [x] Init failure logs diagnostics (REQ-ERR-040) — verified by inspection
- [x] Panic boundary policy satisfied for all extern "C" functions (REQ-FFI-030)
- [x] All exports use `#[no_mangle]` + `extern "C"` (REQ-FFI-040)
- [x] No re-entrant mutable FFI calls (REQ-FFI-060)
- [x] No thread spawning in ffi.rs (REQ-THR-010)
- [x] No synchronization primitives in ffi.rs (REQ-THR-020)
- [x] Global state uses UnsafeCell (REQ-THR-030)
- [x] `unsafe impl Sync` has SAFETY comment (REQ-THR-035)
- [x] No deferred patterns in ffi.rs
- [x] No .unwrap()/.expect() in production FFI code

@plan PLAN-20260223-GFX-FULL-PORT.P13
@requirement REQ-INIT-095, REQ-INIT-096, REQ-ERR-010, REQ-ERR-030,
             REQ-ERR-040, REQ-ERR-050, REQ-ERR-060, REQ-FFI-030,
             REQ-FFI-040, REQ-FFI-060, REQ-THR-010, REQ-THR-020,
             REQ-THR-030, REQ-THR-035, REQ-SEQ-070, REQ-INV-040,
             REQ-INV-050, REQ-UTS-010, REQ-SURF-030, REQ-AUX-060
