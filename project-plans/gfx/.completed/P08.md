# Phase P08: Screen Compositing — Implementation

## Phase ID
`PLAN-20260223-GFX-FULL-PORT.P08`

## Completion
- **Timestamp**: 2026-02-23
- **Status**: Complete

## Files Modified
- `rust/src/graphics/ffi.rs` — `rust_gfx_screen` fully implemented (unscaled path)

## Functions Implemented
- `rust_gfx_screen(screen, alpha, rect)` — full ScreenLayer compositing:
  - Reads surface pixels from `surfaces[screen]`
  - Creates per-call streaming texture (RGBX8888, 320×240)
  - Uploads full surface via `texture.update()` using surface pitch
  - Sets blend mode: `None` for alpha=255, `Blend` for alpha<255
  - Sets alpha mod when alpha < 255
  - Calls `canvas.copy()` with `src_rect == dst_rect` (from `convert_c_rect`)
  - Returns early on texture creation or update failure
  - All `SAFETY` comments on unsafe blocks
  - No per-frame logging (REQ-ERR-030 compliant)

## Requirements Implemented
- REQ-SCR-010: ScreenLayer composites screen surfaces
- REQ-SCR-020: Full surface upload every call
- REQ-SCR-030: Opaque rendering (alpha=255, BlendMode::None)
- REQ-SCR-040: Alpha-blended rendering (alpha<255, BlendMode::Blend)
- REQ-SCR-050: Full screen (rect=NULL → None)
- REQ-SCR-060: Clipped region (rect non-NULL → src_rect == dst_rect)
- REQ-SCR-070: Per-call temporary texture
- REQ-SCR-075: Surface pitch used for upload
- REQ-SCR-090: Extra screen skip (preserved from P06)
- REQ-SCR-100: Screen range check (preserved from P06)
- REQ-SCR-110: Null surface guard (preserved from P06)
- REQ-SCR-120: Pixel pointer/pitch validation
- REQ-SCR-130: Texture creation failure → early return
- REQ-SCR-140: Uninitialized guard (preserved from P06)
- REQ-SCR-150: Rect passthrough (no coordinate transformation)
- REQ-SCR-160: Negative width/height clamped (via convert_c_rect from P06)
- REQ-SCR-170: Pixel slice construction (from_raw_parts with pitch × height)
- REQ-FMT-020: Texture format RGBX8888
- REQ-ERR-065: No copy on update failure
- REQ-NP-025: Texture dropped before return (Rust ownership)

## Tests
- All P06/P07 tests verified passing (1029 pass, 2 pre-existing failures unrelated to graphics)
- Pre-existing failures: `test_resolve_mount_path_with_mount` (io/uio_bridge), `test_ffi_cache_empty_data` (resource/ffi) — both pass in isolation, race conditions in parallel test execution

## Verification
- `cargo fmt --all --check`: no new issues in graphics/ffi.rs
- `cargo clippy`: no new warnings in rust_gfx_screen
- Deferred implementation detection: CLEAN (no TODO/FIXME/HACK/todo!/unimplemented! in rust_gfx_screen)

## Semantic Verification
- [x] ScreenLayer reads surface pixels (not just presenting nothing)
- [x] Texture format is RGBX8888 matching surface format
- [x] Blend mode set correctly for alpha=255 (None) vs alpha<255 (Blend)
- [x] Alpha mod set when alpha < 255
- [x] canvas.copy called with correct rect parameters
- [x] Function returns early on texture.update failure (REQ-ERR-065)
- [x] No per-frame logging (REQ-ERR-030)
- [x] Surface pixels are NOT modified (read-only slice)
- [x] Texture dropped at end of scope (Rust ownership guarantees)

## Notes
- Postprocess upload logic retained until verified ScreenLayer works end-to-end
- Same unsafe pixel access pattern as working postprocess code (`let surf = &*src_surface`)
- Scaled path not yet implemented (deferred to future phase)
