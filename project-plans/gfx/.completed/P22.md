# Phase 22: C File Guards — Level 0 (Scalers) — Completed

- **Phase ID**: PLAN-20260223-GFX-FULL-PORT.P22
- **Completed**: 2026-02-23
- **Status**: [PARTIAL] Guards applied only to files with no unguarded dependents

## Scope Reduction

The original plan called for guarding 10 scaler files and 5 primitives/geometry
files (15 total). Dependency analysis during implementation revealed that most
scaler files **cannot** be guarded because unguarded C code still depends on them:

- `canvas.c` (unguarded) → `rotozoom.c` (`rotateSurface`, `rotozoomSurfaceSize`)
- `scalers.c` (partially guarded) → `2xscalers.c` (`Scale_C_Functions[]`)
- `2xscalers.c` → template files (`nearest2x.c`, `bilinear2x.c`, `biadv2x.c`,
  `triscan2x.c`, `hq2x.c`) for `Scale_BilinearFilter`, `Scale_Nearest`, etc.

The 5 primitives/geometry files (`primitives.c`, `clipline.c`, `boxint.c`,
`bbox.c`, `intersec.c`) are also still called by the unguarded C drawing
pipeline and cannot be guarded yet.

## Files Modified (3)

| File | Guard Type | Notes |
|------|-----------|-------|
| `sdl/2xscalers_mmx.c` | `#ifndef USE_RUST_GFX` | Already gated by `#if defined(MMX_ASM)` internally |
| `sdl/2xscalers_sse.c` | `#ifndef USE_RUST_GFX` | Already gated by `#if defined(MMX_ASM)` internally |
| `sdl/2xscalers_3dnow.c` | `#ifndef USE_RUST_GFX` | Already gated by `#if defined(MMX_ASM)` internally |

## Files NOT Guarded (with rationale)

| File | Reason |
|------|--------|
| `sdl/2xscalers.c` | `Scale_C_Functions[]` referenced by `scalers.c` |
| `sdl/nearest2x.c` | Scaler functions referenced by `2xscalers.c` lookup table |
| `sdl/bilinear2x.c` | Scaler functions referenced by `2xscalers.c` lookup table |
| `sdl/biadv2x.c` | Scaler functions referenced by `2xscalers.c` lookup table |
| `sdl/triscan2x.c` | Scaler functions referenced by `2xscalers.c` lookup table |
| `sdl/hq2x.c` | Scaler functions referenced by `2xscalers.c` lookup table |
| `sdl/rotozoom.c` | `rotateSurface`/`rotozoomSurfaceSize` called from `canvas.c` |
| `sdl/primitives.c` | Used by C drawing pipeline |
| `clipline.c` | Used by C drawing pipeline |
| `boxint.c` | Used by C drawing pipeline |
| `bbox.c` | Used by C drawing pipeline |
| `intersec.c` | Used by C drawing pipeline |

## Total Guard Count

- Pre-existing: 2 files (`scalers.c` partial, `sdl_common.c` partial)
- New in P22: 3 files (`2xscalers_mmx.c`, `2xscalers_sse.c`, `2xscalers_3dnow.c`)
- Header: 1 file (`rust_gfx.h` — declarations only)
- **Total: 6 files** with `USE_RUST_GFX` references

## Verification Results

```
C build: PASS (cd sc2 && ./build.sh uqm)
No undefined symbols: PASS
No compilation errors: PASS
Guard count: 6 files (grep -rl USE_RUST_GFX sc2/src/libs/graphics/ | wc -l)
```

## Key Insight

The C graphics pipeline has deep dependency chains. Scaler files cannot be
individually guarded until their consumer files (`scalers.c`, `canvas.c`) are
also guarded. The MMX/SSE/3DNow variants are safe to guard because they are
already conditionally compiled (`#if defined(MMX_ASM)`) and their symbols are
only referenced from within `#if defined(MMX_ASM)` blocks in `scalers.c`.

The remaining scaler files will become guardable when `canvas.c` and `scalers.c`
themselves are guarded (Phase P23 or later).
