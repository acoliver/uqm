# Phase P03: Seek-Past-End Fix — Completed

## Phase ID
`PLAN-20260224-STATE-SWAP.P03`

## Status
**COMPLETE** — All changes fully implemented (no `todo!()` stubs).

## Files Modified
- `rust/src/state/state_file.rs`

## Changes Made

### Structural Changes
1. **Added `used: usize` field** to `StateFile` struct — tracks logical high-water mark of bytes written, distinct from `data.len()` (physical allocation size).
2. **Changed `open_count: u32` to `open_count: i32`** — matches C `int` semantics; can go negative on close-without-open.

### Behavioral Changes
3. **`StateFile::new()`** — initializes `used = 0`.
4. **`length()`** — returns `self.used` instead of `self.data.len()`. This is the logical size (what `LengthStateFile` returns in C).
5. **`seek()`** — removed upper-bound clamping. Cursor can now be set to any non-negative value. `SeekWhence::End` uses `self.used` (logical size) instead of `self.data.len()`. Only negative results are clamped to 0.
6. **`open()`** — pre-allocates `data` to `size_hint` on first open (when `data.is_empty()`). Write mode resets `self.used = 0` but keeps the physical allocation. Read/ReadWrite modes preserve `used`.
7. **`write()`** — after writing, updates `self.used = self.used.max(self.ptr)` (high-water mark). Growth uses `max(required_end, data.len() * 3/2)` and updates `size_hint` if grown beyond it.
8. **`read()`** — unchanged; correctly checks against `self.data.len()` (physical bounds).
9. **`delete()`** — resets `self.used = 0` in addition to clearing data.
10. **`close()`** — decrements `open_count` unconditionally (no floor), matching C semantics.

### Test Fixups
- **`test_state_file_seek_current`** — updated to expect unclamped seek positions (13 instead of 10, 8 instead of 5) and adjusted the read assertion accordingly (2 bytes "ld" instead of 3 bytes "Wor").

## Verification
- `cargo test --lib --all-features` — **1321 passed, 0 failed, 4 ignored**
- All existing tests pass with the new used/physical distinction
- No `todo!()` markers — everything fully implemented

## Requirements Addressed
- **REQ-SF-001**: Seek-past-end allowed — cursor can be set to any non-negative value without upper-bound clamping
- **REQ-SF-005**: Separate used and physical size tracking — `used` field distinct from `data.len()`

## Pseudocode Traceability
- Lines 51–60 (seek): Implemented — no upper clamp, negative → 0, End uses `self.used`
- Lines 63–72 (read): Verified — checks `self.data.len()` for physical bounds
- Lines 75–90 (write/length): Implemented — high-water mark update, `length()` returns `used`
- Lines 93–116 (open/delete): Implemented — pre-allocation, Write resets `used`, delete clears all
