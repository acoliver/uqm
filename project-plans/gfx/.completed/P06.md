# Phase P06: Screen Compositing Stub — Completed

## Phase ID
`PLAN-20260223-GFX-FULL-PORT.P06`

## Completion Date
2026-02-23

## Summary
Replaced `rust_gfx_screen` no-op with a proper guard-and-stub implementation.
Added `convert_c_rect` helper function for C SDL_Rect → sdl2::rect::Rect conversion.

## Changes Made

### `rust/src/graphics/ffi.rs`
1. **`TFB_SCREEN_EXTRA` constant** — Added `const TFB_SCREEN_EXTRA: c_int = 1` for extra screen index.
2. **`rust_gfx_screen`** — Replaced no-op with full guard structure:
   - REQ-SCR-140: Uninitialized guard (returns if `get_gfx_state()` is None)
   - REQ-SCR-100: Screen range check (returns if screen < 0 or >= 3)
   - REQ-SCR-090: Extra screen skip (returns immediately for screen == 1)
   - REQ-SCR-110: Null surface guard (returns if surface pointer is null)
   - Body: Log-and-return stub (no `todo!()` — safe for game to call every frame)
3. **`convert_c_rect`** — New helper function:
   - Null pointer → None
   - Non-null → safely dereference and convert to `sdl2::rect::Rect`
   - REQ-SCR-160: Negative width/height clamped to 0 (sdl2 further clamps to 1)
4. **`@plan` / `@requirement` markers** — Added to both functions.
5. **7 new tests** added for P06 functionality:
   - `test_gfx_screen_uninitialized_no_panic`
   - `test_gfx_screen_out_of_range_no_panic`
   - `test_gfx_screen_extra_skip_no_panic`
   - `test_convert_c_rect_null_returns_none`
   - `test_convert_c_rect_valid_rect`
   - `test_convert_c_rect_negative_dimensions_clamped`
   - `test_convert_c_rect_zero_size`

## Verification
- `cargo test --lib --all-features`: **1029 passed**, 0 failed, 4 ignored
- No `todo!()` or `unimplemented!()` in the stub body (game-safe)
- All guard clauses return early with no side effects

## Requirements Satisfied
- REQ-SCR-140: Uninitialized guard
- REQ-SCR-100: Out-of-range screen guard
- REQ-SCR-090: Extra screen (TFB_SCREEN_EXTRA) skip
- REQ-SCR-110: Null surface guard
- REQ-SCR-160: Negative dimension clamping in convert_c_rect

## Notes
- The postprocess upload logic still handles actual rendering.
- Full screen compositing (texture upload, alpha blending) is deferred to P08.
- `sdl2::rect::Rect` clamps minimum width/height to 1 (library behavior); tests document this.
