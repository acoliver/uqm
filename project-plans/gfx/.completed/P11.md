# Phase P11: Color Layer — Implementation

## Phase ID
`PLAN-20260223-GFX-FULL-PORT.P11`

## Completion
- **Timestamp**: 2026-02-23
- **Status**: Complete

## Files Modified
- `rust/src/graphics/ffi.rs`

## Changes
- **`rust_gfx_color`**: Replaced log-once stub with full implementation:
  1. Set blend mode: `BlendMode::None` for a=255, `BlendMode::Blend` for a<255 (REQ-CLR-020/030)
  2. Set draw color: `canvas.set_draw_color(Color::RGBA(r, g, b, a))` (REQ-CLR-010)
  3. Convert rect: `convert_c_rect(rect)` — None fills entire screen (REQ-CLR-040/050)
  4. Fill: `let _ = canvas.fill_rect(sdl_rect)` — errors ignored per REQ-ERR-065
- Removed `color_stub_logged` field from `GfxState` struct
- Removed `color_stub_logged: false` from constructor
- Added `// SAFETY:` comment on unsafe rect pointer dereference
- Updated plan markers to P11, added all requirement references

## Requirements Implemented
- REQ-CLR-010: Set draw color (r, g, b, a)
- REQ-CLR-020: Opaque blend mode (a=255 → BLENDMODE_NONE)
- REQ-CLR-030: Alpha blend mode (a<255 → BLENDMODE_BLEND)
- REQ-CLR-040: Fill entire screen (rect=NULL → fill_rect(None))
- REQ-CLR-050: Fill rectangle (rect non-NULL → fill_rect(Some(rect)))
- REQ-CLR-055: Negative rect dimension guard (pre-existing from P09)
- REQ-CLR-060: Uninitialized guard (pre-existing from P09)

## C Reference Match
Matches `TFB_SDL2_ColorLayer` in `sdl2_pure.c`:
```c
SDL_SetRenderDrawBlendMode(renderer, (a == 255) ? SDL_BLENDMODE_NONE : SDL_BLENDMODE_BLEND);
SDL_SetRenderDrawColor(renderer, r, g, b, a);
SDL_RenderFillRect(renderer, rect);
```

## Verification
- `cargo test --lib --all-features`: 1033 passed, 1 failed (pre-existing flaky `test_ffi_cache_clear_and_size` — passes in isolation, fails due to test ordering/global state; unrelated to graphics)
- All 3 color layer tests pass: `test_gfx_color_uninitialized_no_panic`, `test_gfx_color_negative_rect_no_panic`, `test_gfx_color_null_rect_no_panic`
- Deferred implementation detection: CLEAN (no TODO/FIXME/HACK/todo!/unimplemented!)

## Semantic Verification
- [x] Matches C reference `TFB_SDL2_ColorLayer`
- [x] Blend mode correct: None for a=255, Blend for a<255
- [x] Color fill works for both null and non-null rect
- [x] No placeholder patterns remain
- [x] Fades should now work visually (fade-to-black, fade-to-white)
