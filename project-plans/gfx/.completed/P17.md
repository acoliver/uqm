# Phase P17: Canvas FFI Bridge — Implementation

## Phase ID
`PLAN-20260223-GFX-FULL-PORT.P17`

## Completion
- **Timestamp**: 2026-02-23
- **Status**: [OK] Complete

## Files Modified
- `rust/src/graphics/canvas_ffi.rs` — Replaced all stubs with full implementations

## Exports
Total `#[no_mangle]` canvas exports: **11**

| Export | Implementation |
|--------|---------------|
| `rust_canvas_from_surface` | Creates SurfaceCanvas from SDL_Surface (functional since P15) |
| `rust_canvas_destroy` | Box::from_raw drop (functional since P15) |
| `rust_canvas_draw_line` | → `Canvas::draw_line` (Bresenham's, scissor-aware) |
| `rust_canvas_draw_rect` | → `draw_rect` (4 lines, scissor-aware) |
| `rust_canvas_fill_rect` | → `fill_rect` (row-by-row, scissor-aware) |
| `rust_canvas_copy` | → `copy_canvas` with SDL_Rect sub-region support |
| `rust_canvas_draw_image` | → temp Canvas + `copy_canvas` for RGBA blit |
| `rust_canvas_draw_fontchar` | → per-pixel alpha blend with fg color |
| `rust_canvas_set_scissor` | → `Canvas::enable_scissor(Rect)` |
| `rust_canvas_clear_scissor` | → `Canvas::disable_scissor()` |
| `rust_canvas_get_extent` | Returns cached width/height (functional since P15) |

## Implementation Details

### Color conversion
- `color_from_u32(u32) -> Color`: unpacks packed RGBA (R high byte, A low byte)
- Used by draw_line, draw_rect, fill_rect, draw_fontchar

### Draw operations
- **draw_line**: Calls `Canvas::draw_line` with Bresenham's algorithm, DrawMode::Normal
- **draw_rect**: Calls `draw_rect(x, y, x+w-1, y+h-1, ...)` converting from x/y/w/h to corners
- **fill_rect**: Calls `fill_rect(x, y, x+w-1, y+h-1, ...)` with row-by-row fill
- **copy**: Creates sub-Canvas from src_rect if provided, calls `copy_canvas`
- **draw_image**: Creates temp Canvas from raw RGBA data, uses `copy_canvas` to blit
- **draw_fontchar**: Per-pixel alpha compositing: `result = fg * alpha + dst * (1-alpha)`
- **set_scissor/clear_scissor**: Direct Canvas scissor enable/disable

### Safety
- All 11 FFI functions use `catch_unwind` for panic safety
- All 8 drawing functions marked `unsafe extern "C"` with `# Safety` docs
- Null checks on all pointer parameters
- No `.unwrap()` or `.expect()` in any FFI function

## Test Results
- **41 tests** all passing
- Pixel-level verification of:
  - Bresenham's line algorithm (horizontal, vertical, diagonal, clipped)
  - Rectangle outline (4 edges, interior empty)
  - Solid fill (all pixels in region, clipping)
  - Image blit (4-pixel RGBA verification)
  - Font glyph alpha blending (arithmetic verification)
  - Scissor clipping (line, fill, fontchar restricted to scissor rect)
  - Canvas copy (full, sub-rect, clipped)

## Verification
```
cargo fmt --all --check     [OK] Pass
cargo clippy (canvas_ffi)   [OK] 0 errors
cargo test --lib             [OK] 1090 pass, 0 fail, 4 ignored
No deferred patterns         [OK] CLEAN (no todo!/TODO/FIXME/HACK/placeholder)
```

## Semantic Verification
- [x] draw_line uses Bresenham's — verified by horizontal/vertical/diagonal pixel checks
- [x] fill_rect fills correct region — verified by 5x5 region scan
- [x] draw_fontchar alpha blending — verified: 50% alpha gives ~127/128 blend
- [x] Scissor clips all operations — verified: line, fill, fontchar outside scissor = empty
- [x] Canvas copy handles sub-rect — verified: 3x3 region, boundary pixel verification
- [x] Bounds checking prevents overflows — verified: clipping tests for all operations
